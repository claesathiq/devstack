global
  maxconn 15000 # Max simultaneous connections from an upstream server
  spread-checks 5 # Distribute health checks with some randomness
  log 127.0.0.1 local0
  log 127.0.0.1 local1 notice
  #debug # Uncomment for verbose logging

defaults # Apply to all services
  log global
  mode http
  balance roundrobin
  option abortonclose # abort request if client closes output channel while waiting
  option httpclose # add "Connection:close" header if it is missing
  option forwardfor # insert x-forwarded-for header so that app servers can see both proxy and client IPs
  option redispatch # any server can handle any session
  timeout client 60s
  timeout connect 9s
  timeout server 30s
  timeout check 5s
  stats enable
  stats uri /stats # Real path redacted
  stats realm Haproxy\ Statistics
  stats auth username:password # Real credentials redacted
  monitor-uri /monitor # Returns 200 if we're up; real path redacted
  errorfile 503 /etc/haproxy/errors/503.http

  userlist shareaholic_admins
    user myuser insecure-password mypass # Real auth redacted

  frontend incoming
    bind *:80
    reqadd X-Forwarded-Proto:\ http

    acl sharingthetech path_beg /tech
    acl tintoretto_app hdr_dom(host) -i tintoretto

    acl php_app path_beg /about /contact /help /media
    acl php_app path /api /api/ /tools/browser /tools/browser/
    acl php_app hdr_dom(host) -i blog.shareaholic.com
    acl php_app hdr_dom(host) -i sexybookmarks.shareaholic.com
    acl php_app hdr_dom(host) -i www.sexybookmarks.shareaholic.com

    use_backend sharingthetech if sharingthetech
    use_backend tintoretto_app if tintoretto_app
    use_backend php_app if php_app

    default_backend rails_app

  frontend incoming_ssl
    bind *:8443 accept-proxy
    reqadd X-Forwarded-Proto:\ https

    acl sharingthetech path_beg /tech
    acl tintoretto_app hdr_dom(host) -i tintoretto

    acl php_app path_beg /about /contact /help /media
    acl php_app path /api /api/ /tools/browser /tools/browser/
    acl php_app hdr_dom(host) -i blog.shareaholic.com
    acl php_app hdr_dom(host) -i sexybookmarks.shareaholic.com
    acl php_app hdr_dom(host) -i www.sexybookmarks.shareaholic.com

    use_backend sharingthetech if sharingthetech
    use_backend tintoretto_app if tintoretto_app
    use_backend php_app if php_app

    default_backend rails_app


  backend sharingthetech :80
    reqirep ^Host: Host:\ shareaholic.com
    server github-pages shareaholic.github.com:80 check inter 5000 fastinter 1000 fall 1 weight 50

  backend php_app :80
    option httpchk HEAD /version.txt HTTP/1.1\r\nHOST:\ www.shareaholic.com
    server master 10.1.1.1:80 check inter 5000 fastinter 1000 fall 1 weight 1
    server slave 10.1.1.2:80 check inter 5000 fastinter 1000 fall 1 weight 1

  backend rails_app :80
    option httpchk /haproxy_health_check
    server rails-1 10.1.1.3:8080 check inter 5000 fastinter 1000 fall 1 rise 1 weight 1 maxconn 100
    server rails-2 10.1.1.4:8080 check inter 5000 fastinter 1000 fall 1 rise 1 weight 1 maxconn 100
    server rails-secondary-a-1 10.1.1.5:8080 check inter 5000 fastinter 1000 fall 1 rise 1 weight 1 maxconn 100
    server rails-secondary-c-1 10.1.1.6:8080 check inter 5000 fastinter 1000 fall 1 rise 1 weight 1 maxconn 100

  backend tintoretto_app :80
    server tintoretto-1 10.1.1.7:8080 check inter 5000 fastinter 1000 fall 1 rise 1 weight 1
    acl auth_tintoretto http_auth(shareaholic_admins)
    http-request auth realm Tintoretto if !auth_tintoretto
